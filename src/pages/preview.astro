---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Preview">
  <main style="max-width: 900px; padding: 24px 16px; margin: 0 auto">
    <h1 class="title">Loading...</h1>
    <p class="publishedAt" style="opacity: 0.7"></p>
    <div class="post"></div>
  </main>
</Layout>

<script>
  type PreviewArticle = {
    title?: string;
    createdAt?: string;
    publishedAt?: string;
    content?: string;
  };

  const params = new URLSearchParams(window.location.search);
  const contentId = params.get("contentId");
  const draftKey = params.get("draftKey");

  const titleElement = document.querySelector(".title");
  const publishedAtElement = document.querySelector(".publishedAt");
  const postElement = document.querySelector(".post");

  if (!contentId || !draftKey) {
    titleElement && (titleElement.textContent = "Missing query parameters");
    publishedAtElement &&
      (publishedAtElement.textContent =
        "Expected: ?contentId={CONTENT_ID}&draftKey={DRAFT_KEY}");
  } else {
    fetch(
      `/api/preview?contentId=${encodeURIComponent(contentId)}&draftKey=${encodeURIComponent(
        draftKey
      )}`
    )
      .then(async (res) => {
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`${res.status} ${res.statusText} ${text}`.trim());
        }
        return (await res.json()) as PreviewArticle;
      })
      .then((data) => {
        titleElement && (titleElement.textContent = data.title ?? "");
        publishedAtElement &&
          (publishedAtElement.textContent =
            data.publishedAt ?? data.createdAt ?? "");
        postElement && (postElement.innerHTML = data.content ?? "");
      })
      .catch((e) => {
        titleElement && (titleElement.textContent = "Preview fetch failed");
        publishedAtElement &&
          (publishedAtElement.textContent =
            e instanceof Error ? e.message : String(e));
      });
  }
</script>
